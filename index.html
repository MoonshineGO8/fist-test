<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTQ Risk Assessment Portal</title>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#3B4083', // Deep Indigo
                            light: '#8F8CB8',
                            accent: '#7AB6B5',
                            bg: '#F8FAFC',
                            success: '#0CC784',
                            warning: '#FFBC5E',
                            danger: '#EF4444'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Kanit', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F8FAFC; color: #3B4083; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #8F8CB8; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ระบบจำลองข้อมูลเบื้องต้น ---
        const MOCK_DATA = [
            { id: 1, 'Status': 'Update', 'CTQ Risk Level': 'HIGH', 'Article#': 'TW6948F26', 'Model Name Short': 'W ULT SET SKT', 'Season': 'FW2026', 'Development Factory Name': 'THONG THAI TEXTILE', 'Retail Intro Date (RID)': '2026-06-01' },
            { id: 2, 'Status': 'Add new', 'CTQ Risk Level': 'LOW', 'Article#': 'S2507M504', 'Model Name Short': 'TF SHRT TIGHT M', 'Season': 'FW2026', 'Development Factory Name': 'THONG THAI TEXTILE', 'Retail Intro Date (RID)': '2026-06-01' },
            { id: 3, 'Status': 'Update', 'CTQ Risk Level': 'MEDIUM', 'Article#': 'ART-8822', 'Model Name Short': 'CORE PERFORMANCE', 'Season': 'SS2026', 'Development Factory Name': 'THONG THAI TEXTILE', 'Retail Intro Date (RID)': '2026-03-15' }
        ];

        const App = () => {
            const [currentTab, setCurrentTab] = useState('overview');
            const [data, setData] = useState(MOCK_DATA);
            const [isImporting, setIsImporting] = useState(false);
            const [history, setHistory] = useState([
                { id: 1, filename: 'Initial_Load.csv', date: '12/01/2026 09:00', rows: 3, status: 'Completed' }
            ]);

            const handleImportSuccess = (newData, filename) => {
                setData(newData);
                setHistory([{
                    id: Date.now(),
                    filename: filename,
                    date: new Date().toLocaleString('th-TH'),
                    rows: newData.length,
                    status: 'Completed'
                }, ...history]);
                setIsImporting(false);
                setCurrentTab('overview');
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-64 bg-brand text-white flex flex-col shadow-xl z-20">
                        <div className="p-6 border-b border-white/10">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-brand-warning rounded-lg text-brand shadow-lg">
                                    <i className="fa-solid fa-shield-halved text-xl"></i>
                                </div>
                                <span className="font-bold text-lg tracking-tight">CTQ Portal</span>
                            </div>
                        </div>
                        
                        <nav className="flex-1 p-4 space-y-1">
                            <button 
                                onClick={() => {setCurrentTab('overview'); setIsImporting(false);}}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${currentTab === 'overview' ? 'bg-white text-brand shadow-lg font-bold' : 'text-brand-light hover:bg-white/10 hover:text-white'}`}
                            >
                                <i className="fa-solid fa-chart-line w-5"></i> Dashboard
                            </button>
                            <button 
                                onClick={() => {setCurrentTab('history'); setIsImporting(false);}}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${currentTab === 'history' ? 'bg-white text-brand shadow-lg font-bold' : 'text-brand-light hover:bg-white/10 hover:text-white'}`}
                            >
                                <i className="fa-solid fa-clock-rotate-left w-5"></i> History
                            </button>
                        </nav>

                        <div className="p-4 mt-auto">
                            <div className="bg-white/5 p-4 rounded-2xl border border-white/10">
                                <p className="text-[10px] uppercase text-brand-light font-bold mb-2">Logged in as</p>
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-brand-accent flex items-center justify-center font-bold text-xs">SA</div>
                                    <div className="text-xs">
                                        <p className="font-bold">Siriwan A.</p>
                                        <p className="opacity-60 italic">Quality Control</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto custom-scrollbar relative">
                        {!isImporting ? (
                            <div className="p-8 animate-fade-in">
                                {currentTab === 'overview' ? (
                                    <Overview data={data} onImport={() => setIsImporting(true)} />
                                ) : (
                                    <History history={history} />
                                )}
                            </div>
                        ) : (
                            <ImportView onCancel={() => setIsImporting(false)} onSuccess={handleImportSuccess} />
                        )}
                    </main>
                </div>
            );
        };

        const Overview = ({ data, onImport }) => {
            const stats = useMemo(() => ({
                total: data.length,
                high: data.filter(d => d['CTQ Risk Level'] === 'HIGH').length,
                med: data.filter(d => d['CTQ Risk Level'] === 'MEDIUM').length,
                low: data.filter(d => d['CTQ Risk Level'] === 'LOW').length
            }), [data]);

            return (
                <div className="max-w-6xl mx-auto">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-brand">Risk Dashboard</h1>
                            <p className="text-brand-light">ข้อมูลประเมินความเสี่ยง CTQ ประจำปี 2026</p>
                        </div>
                        <button 
                            onClick={onImport}
                            className="bg-brand text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 hover:shadow-lg hover:-translate-y-0.5 transition-all"
                        >
                            <i className="fa-solid fa-file-import"></i> Import Data
                        </button>
                    </header>

                    {/* Stat Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                        <div className="bg-white p-6 rounded-2xl border border-brand-light/20 shadow-sm">
                            <p className="text-xs font-bold text-brand-light uppercase">Total Items</p>
                            <h2 className="text-3xl font-bold mt-1">{stats.total}</h2>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border-l-4 border-l-brand-danger border-brand-light/20 shadow-sm">
                            <p className="text-xs font-bold text-brand-danger uppercase">High Risk</p>
                            <h2 className="text-3xl font-bold mt-1 text-brand-danger">{stats.high}</h2>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border-l-4 border-l-brand-warning border-brand-light/20 shadow-sm">
                            <p className="text-xs font-bold text-orange-500 uppercase">Medium Risk</p>
                            <h2 className="text-3xl font-bold mt-1 text-orange-500">{stats.med}</h2>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border-l-4 border-l-brand-success border-brand-light/20 shadow-sm">
                            <p className="text-xs font-bold text-brand-success uppercase">Low Risk</p>
                            <h2 className="text-3xl font-bold mt-1 text-brand-success">{stats.low}</h2>
                        </div>
                    </div>

                    {/* Data Table */}
                    <div className="bg-white rounded-2xl shadow-sm border border-brand-light/20 overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-brand-bg text-brand-light text-xs font-bold uppercase tracking-wider">
                                <tr>
                                    <th className="px-6 py-4">Article#</th>
                                    <th className="px-6 py-4">Model Name</th>
                                    <th className="px-6 py-4">Risk Level</th>
                                    <th className="px-6 py-4">Season</th>
                                    <th className="px-6 py-4">Factory</th>
                                    <th className="px-6 py-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-brand-light/10">
                                {data.map((item, idx) => (
                                    <tr key={idx} className="hover:bg-brand-bg transition-colors">
                                        <td className="px-6 py-4 font-bold font-mono text-sm">{item['Article#']}</td>
                                        <td className="px-6 py-4 text-sm">{item['Model Name Short']}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-3 py-1 rounded-full text-[10px] font-bold border ${
                                                item['CTQ Risk Level'] === 'HIGH' ? 'bg-red-50 text-red-600 border-red-200' :
                                                item['CTQ Risk Level'] === 'MEDIUM' ? 'bg-orange-50 text-orange-600 border-orange-200' :
                                                'bg-emerald-50 text-emerald-600 border-emerald-200'
                                            }`}>
                                                {item['CTQ Risk Level']}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-sm text-brand-light">{item['Season']}</td>
                                        <td className="px-6 py-4 text-sm text-brand-light truncate max-w-[150px]">{item['Development Factory Name']}</td>
                                        <td className="px-6 py-4 text-center">
                                            <button className="text-brand-light hover:text-brand"><i className="fa-solid fa-ellipsis"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ImportView = ({ onCancel, onSuccess }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [error, setError] = useState(null);
            const [preview, setPreview] = useState(null);

            const processFile = (file) => {
                if (!file.name.endsWith('.csv')) {
                    setError('กรุณาอัปโหลดไฟล์นามสกุล .csv เท่านั้น');
                    return;
                }
                
                setError(null);
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: 'greedy',
                    transformHeader: (h) => h.replace(/^\uFEFF/, '').trim(),
                    complete: (results) => {
                        const headers = results.meta.fields || [];
                        
                        // --- FIXED: Flexible Column Matching ---
                        // ค้นหาคอลัมน์แบบยืดหยุ่น (ไม่สนใจเว้นวรรคหรืออักษรเล็กใหญ่)
                        const articleKey = headers.find(h => {
                            const c = h.toLowerCase().trim();
                            return (c.includes('article') && c.includes('#')) || c === 'article' || c === 'article#';
                        });
                        
                        const workingKey = headers.find(h => {
                            const c = h.toLowerCase().trim();
                            return (c.includes('working') && c.includes('#')) || c.includes('working number');
                        });

                        const riskKey = headers.find(h => h.toLowerCase().includes('risk') && h.toLowerCase().includes('level'));

                        if (!articleKey && !workingKey) {
                            setError(`ไม่พบคอลัมน์ Article# หรือ Working# (พบคอลัมน์: ${headers.slice(0,3).join(', ')}...)`);
                            return;
                        }

                        const normalized = results.data.map(row => ({
                            ...row,
                            'Article#': (row[articleKey] || row[workingKey] || 'N/A').toString().trim(),
                            'CTQ Risk Level': row[riskKey] || 'LOW'
                        }));

                        setPreview({ filename: file.name, data: normalized });
                    }
                });
            };

            return (
                <div className="p-8 max-w-4xl mx-auto animate-fade-in">
                    <button onClick={onCancel} className="flex items-center gap-2 text-brand-light hover:text-brand font-bold mb-6">
                        <i className="fa-solid fa-arrow-left"></i> กลับหน้าหลัก
                    </button>
                    
                    <div className="bg-white rounded-3xl border border-brand-light/20 shadow-xl overflow-hidden">
                        <div className="p-10 text-center bg-brand-bg border-b border-brand-light/10">
                            <h2 className="text-2xl font-bold mb-2">อัปโหลดข้อมูลความเสี่ยง</h2>
                            <p className="text-brand-light">รองรับไฟล์ CSV จาก SmartSheet หรือ Excel</p>
                        </div>

                        <div className="p-10">
                            {!preview ? (
                                <div 
                                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                                    onDragLeave={() => setIsDragging(false)}
                                    onDrop={(e) => { e.preventDefault(); setIsDragging(false); processFile(e.dataTransfer.files[0]); }}
                                    className={`border-4 border-dashed rounded-3xl p-16 flex flex-col items-center justify-center transition-all cursor-pointer ${isDragging ? 'border-brand bg-brand/5' : 'border-brand-light/20'}`}
                                >
                                    <input type="file" accept=".csv" onChange={(e) => processFile(e.target.files[0])} className="hidden" id="fileInput" />
                                    <label htmlFor="fileInput" className="cursor-pointer flex flex-col items-center">
                                        <div className="w-20 h-20 bg-brand-bg rounded-full flex items-center justify-center text-brand text-3xl mb-4">
                                            <i className="fa-solid fa-cloud-arrow-up"></i>
                                        </div>
                                        <p className="text-xl font-bold">คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวาง</p>
                                        <p className="text-sm text-brand-light mt-2 italic font-medium">ระบบแก้ไขปัญหา "ไม่พบคอลัมน์" แล้ว รองรับหัวตารางได้หลายรูปแบบ</p>
                                    </label>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <div className="flex items-center justify-between p-5 bg-emerald-50 border border-emerald-200 rounded-2xl">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-emerald-500 shadow-sm border border-emerald-100">
                                                <i className="fa-solid fa-file-csv text-2xl"></i>
                                            </div>
                                            <div>
                                                <p className="font-bold text-emerald-900">{preview.filename}</p>
                                                <p className="text-xs text-emerald-700">ตรวจพบข้อมูลทั้งหมด {preview.data.length} รายการ</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setPreview(null)} className="text-emerald-700 hover:text-red-500"><i className="fa-solid fa-trash-can"></i></button>
                                    </div>

                                    <div className="bg-brand-bg rounded-2xl p-6 border border-brand-light/10">
                                        <h3 className="text-xs font-bold uppercase text-brand-light mb-4">Preview ข้อมูล 3 แถวแรก</h3>
                                        <div className="space-y-3">
                                            {preview.data.slice(0, 3).map((row, i) => (
                                                <div key={i} className="flex justify-between items-center text-sm bg-white p-3 rounded-xl border border-brand-light/10">
                                                    <span className="font-bold">{row['Article#']}</span>
                                                    <span className="text-brand-light">{row['Model Name Short'] || 'No Model Name'}</span>
                                                    <span className="text-[10px] font-bold bg-brand-bg px-2 py-1 rounded border uppercase">{row['CTQ Risk Level']}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex gap-4 pt-4">
                                        <button onClick={() => setPreview(null)} className="flex-1 py-3 text-brand-light font-bold hover:bg-brand-bg rounded-xl transition-all">Cancel</button>
                                        <button 
                                            onClick={() => onSuccess(preview.data, preview.filename)}
                                            className="flex-1 py-3 bg-brand text-white font-bold rounded-xl shadow-lg shadow-brand/20 hover:-translate-y-1 transition-all"
                                        >
                                            Confirm & Update Dashboard
                                        </button>
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div className="mt-6 p-4 bg-red-50 border border-red-100 text-red-600 rounded-2xl text-sm flex items-start gap-3">
                                    <i className="fa-solid fa-circle-exclamation mt-0.5"></i>
                                    <div>
                                        <p className="font-bold">Error: อัปโหลดล้มเหลว</p>
                                        <p className="opacity-80">{error}</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const History = ({ history }) => (
            <div className="max-w-4xl mx-auto">
                <h1 className="text-2xl font-bold text-brand mb-8">ประวัติการอัปโหลด</h1>
                <div className="space-y-4">
                    {history.map(item => (
                        <div key={item.id} className="bg-white p-6 rounded-2xl border border-brand-light/20 flex items-center justify-between shadow-sm hover:shadow-md transition-all">
                            <div className="flex items-center gap-5">
                                <div className="w-12 h-12 bg-brand-bg rounded-2xl flex items-center justify-center text-brand">
                                    <i className="fa-solid fa-cloud-check text-xl"></i>
                                </div>
                                <div>
                                    <p className="font-bold">{item.filename}</p>
                                    <p className="text-xs text-brand-light">อัปโหลดเมื่อ: {item.date}</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-sm font-bold">{item.rows} records</p>
                                <span className="text-[10px] font-bold uppercase text-brand-success bg-brand-success/10 px-2 py-1 rounded border border-brand-success/20">Success</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
